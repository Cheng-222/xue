<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>幸运转盘</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px circle at 20% 10%,#ffe8e8,#e9f7ff 35%,#f6fff2 70%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial;color:#222;display:flex;align-items:center;justify-content:center;padding:16px}
    .app{width:100%;max-width:1000px}
    .card{background:rgba(255,255,255,.9);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.15);padding:18px}
    h1{margin:0 0 12px;font-size:24px;text-align:center;color:#00aeec;letter-spacing:.2em}
    .top{display:flex;gap:18px;align-items:center;justify-content:center;flex-wrap:wrap}
    .wheel-wrap{position:relative;width:70vmin;height:70vmin;min-width:280px;min-height:280px}
    .rotor{width:100%;height:100%;border-radius:50%;box-shadow:inset 0 0 40px rgba(0,0,0,.08),0 12px 24px rgba(0,0,0,.12);background:#fff;display:grid;place-items:center}
    canvas{width:95%;height:95%}
    .pointer{position:absolute;left:50%;top:-2px;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid #ff5252;filter:drop-shadow(0 8px 12px rgba(0,0,0,.2))}
    .panel{flex:1;min-width:280px;display:flex;flex-direction:column;gap:8px}
    label{font-size:13px;color:#666}
    input[type=number]{width:100%;border:1px solid #e6e6e6;border-radius:12px;padding:10px 12px;font-size:14px;background:rgba(255,255,255,.8);outline:none}
    .items{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    input.prize-input{width:100%;border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;font-size:14px;background:rgba(255,255,255,.8);outline:none}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}
    button{flex:1;border:0;border-radius:14px;padding:12px 16px;background:#f0f3f7;color:#333;font-weight:600;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease}
    button:hover{transform:translateY(-1px)}
    button.primary{background:#00aeec;color:#fff;box-shadow:0 10px 18px rgba(0,174,236,.25)}
    .result{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .result .box{width:min(92vw,520px);background:#fff;border-radius:20px;padding:26px 22px;text-align:center;box-shadow:0 30px 60px rgba(0,0,0,.3)}
    .result .title{font-size:18px;color:#666;margin-bottom:8px}
    .result .name{font-size:28px;font-weight:800;margin:8px 0 18px;color:#ff5252}
    #confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .c{position:absolute;top:-10px;width:8px;height:14px;border-radius:2px;transform:rotate(20deg);animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(360deg)}}
    /* 返回菜单按钮 */
    .back-btn{position:fixed;top:16px;left:16px;padding:10px 14px;border-radius:999px;background:linear-gradient(135deg,#ff8fb1,#8cc0ff);color:#fff;text-decoration:none;font-weight:700;box-shadow:0 8px 18px rgba(0,0,0,.12);transition:transform .15s ease,box-shadow .15s ease}
    .back-btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(0,0,0,.16)}
    @media (max-width:480px){h1{font-size:20px}.items{grid-template-columns:1fr}.back-btn{padding:12px 16px;font-size:14px}}
  </style>
</head>
<body>
  <a href="index.html" class="back-btn" aria-label="返回菜单">← 返回菜单</a>
  <div class="app">
    <div class="card">
      <h1>幸运转盘</h1>
      <div class="top">
        <div class="wheel-wrap">
          <div class="pointer"></div>
          <div class="rotor" id="rotor"><canvas id="wheel"></canvas></div>
        </div>
        <div class="panel">
          <label>分区数量</label>
          <input id="count" type="number" min="2" max="24" value="8">
          <label>奖品（按分区自动生成）</label>
          <div id="items" class="items"></div>
          <div class="btns">
            <button id="build">生成转盘</button>
            <button id="spin" class="primary">开始抽奖</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="result" id="result">
    <div class="box">
      <div class="title">恭喜你抽中</div>
      <div class="name" id="prizeName"></div>
      <button id="close" class="primary">再来一次</button>
    </div>
  </div>
  <div id="confetti"></div>
  <script>
    const canvas=document.getElementById('wheel'),ctx=canvas.getContext('2d'),rotor=document.getElementById('rotor'),result=document.getElementById('result'),prizeEl=document.getElementById('prizeName'),itemsEl=document.getElementById('items'),countEl=document.getElementById('count');
    const size=800;canvas.width=size;canvas.height=size;let prizes=JSON.parse(localStorage.getItem('wheel.prizes')||'[]');let segments=parseInt(localStorage.getItem('wheel.count')||prizes.length||8);
    if(!prizes.length){prizes=['谢谢参与','糖果','电影票','咖啡券','随机红包','耳机','书籍','周边']}
    segments=Math.max(2,Math.min(24,segments||prizes.length));countEl.value=segments;
    function syncInputs(n,existing){n=Math.max(2,Math.min(24,parseInt(n)||segments));const old=existing||Array.from(itemsEl.querySelectorAll('.prize-input')).map(i=>i.value);itemsEl.innerHTML='';for(let i=0;i<n;i++){const inp=document.createElement('input');inp.type='text';inp.className='prize-input';inp.placeholder=`奖品${i+1}`;inp.value=(old[i]??prizes[i]??'');itemsEl.appendChild(inp)}segments=n}
    syncInputs(segments);
    function readPrizes(){const vals=Array.from(itemsEl.querySelectorAll('.prize-input')).map((inp,i)=>{const v=inp.value.trim();return v||`奖品${i+1}`});return vals}
    function fitLines(text,avail,maxFont,minFont){const isCJK=/[\u4e00-\u9fff]/.test(text);let tokens=isCJK?text.split(''):text.split(/\s+/).filter(Boolean);for(let font=maxFont;font>=minFont;font-=1){ctx.font=`${font}px system-ui`;if(ctx.measureText(text).width<=avail)return{lines:[text],font};let line1='',line2='';let k=0;for(;k<tokens.length;k++){const t1=line1+(isCJK?tokens[k]:(line1?' ':'')+tokens[k]);if(ctx.measureText(t1).width<=avail){line1=t1}else{break}}for(let j=k;j<tokens.length;j++){const t2=line2+(isCJK?tokens[j]:(line2?' ':'')+tokens[j]);if(ctx.measureText(t2).width<=avail){line2=t2}else{while(line2 && ctx.measureText(line2+'…').width>avail){line2=isCJK?line2.slice(0,-1):line2.replace(/\s*\S+$/,'')}line2=line2?(line2+'…'):'…';return{lines:[line1,line2],font}}}if(line1||line2)return{lines:[line1,line2].filter(Boolean),font}}ctx.font=`${minFont}px system-ui`;let t=text;while(t && ctx.measureText(t+'…').width>avail){t=isCJK?t.slice(0,-1):t.replace(/\s*\S+$/,'')}return{lines:[t?(t+'…'):'…'],font:minFont}}
    function draw(){const r=size/2;ctx.clearRect(0,0,size,size);const per=2*Math.PI/segments;for(let i=0;i<segments;i++){ctx.beginPath();ctx.moveTo(r,r);ctx.arc(r,r,r-10,i*per,(i+1)*per);ctx.fillStyle=`hsl(${i*360/segments},70%,60%)`;ctx.fill();ctx.save();ctx.translate(r,r);ctx.rotate(i*per+per/2);const text=prizes[i%prizes.length]||`奖品${i+1}`;const labelR=r*(0.62-Math.min(0.12,Math.max(0,segments-8)*0.01));const avail=2*labelR*Math.sin(per/2)-10;const baseFont=Math.max(12,r*0.09);const {lines,font}=fitLines(text,Math.max(40,avail),baseFont,10);ctx.fillStyle='#222';ctx.textAlign='center';ctx.textBaseline='middle';ctx.font=`${font}px system-ui`;if(lines.length<=1){ctx.fillText(lines[0],0,-labelR)}else{const gap=Math.max(10,font*0.9);ctx.fillText(lines[0],0,-labelR-gap/2);ctx.fillText(lines[1],0,-labelR+gap/2)}ctx.restore()}ctx.beginPath();ctx.arc(r,r,r*0.08,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.beginPath();ctx.arc(r,r,r*0.03,0,Math.PI*2);ctx.fillStyle='#ff5252';ctx.fill()}
    draw();
    countEl.addEventListener('input',()=>{syncInputs(countEl.value)});
    document.getElementById('build').onclick=function(){syncInputs(countEl.value);prizes=readPrizes();segments=prizes.length;countEl.value=segments;localStorage.setItem('wheel.prizes',JSON.stringify(prizes));localStorage.setItem('wheel.count',segments);rotor.style.transition='none';rotor.style.transform='rotate(0deg)';setTimeout(()=>{rotor.offsetHeight;draw();rotor.style.transition=''},50)};
    let spinning=false,winIndex=0;
    document.getElementById('spin').onclick=function(){if(spinning)return;spinning=true;const per=360/segments;winIndex=Math.floor(Math.random()*segments);const turns=6+Math.floor(Math.random()*4);const finalDeg=360*turns-90-per*(winIndex+0.5);rotor.style.transition='transform 5.5s cubic-bezier(.15,.6,0,.99)';rotor.style.transform=`rotate(${finalDeg}deg)`};
    rotor.addEventListener('transitionend',function(){const name=prizes[winIndex%prizes.length]||`奖品${winIndex+1}`;prizeEl.textContent=name;result.style.display='flex';makeConfetti();spinning=false});
    document.getElementById('close').onclick=function(){result.style.display='none'};
    function makeConfetti(){const box=document.getElementById('confetti');box.innerHTML='';for(let i=0;i<60;i++){const c=document.createElement('div');c.className='c';c.style.left=Math.random()*100+'%';c.style.background=`hsl(${Math.random()*360},80%,60%)`;c.style.animationDuration=(3+Math.random()*2)+'s';c.style.opacity=.7;box.appendChild(c)}setTimeout(()=>box.innerHTML='',6000)}
  </script>
</body>
</html>